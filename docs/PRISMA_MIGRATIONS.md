# Coolify + Prisma Migration Strategy

How database migrations work in this project, why they work this way, and how to set this up in new projects.

---

## The problem

When deploying a containerized Prisma app on Coolify, the database schema must be updated **before** the app starts serving traffic. If the Prisma Client expects columns that don't exist yet, every query fails with `P2022: The column does not exist`.

Coolify offers pre/post-deployment hooks, but neither is suitable for migrations:

| Hook | Runs in | Problem |
|------|---------|---------|
| **Pre-deployment** | Old (existing) container | Old container has old migration files — new migrations are invisible |
| **Post-deployment** | New container | If the command fails, the container **keeps running anyway** (no rollback) |

The correct approach is a **container entrypoint script** that runs `prisma migrate deploy` before `node server.js`. If migrations fail, the container fails to start — Coolify sees a failed health check and does not route traffic to it.

---

## How it works in this project

### Entrypoint script (`scripts/start.sh`)

```sh
#!/bin/sh
set -e

echo "[canopy-forms] Running database migrations..."
node ./node_modules/prisma/build/index.js migrate deploy

echo "[canopy-forms] Migrations complete. Starting application..."
exec node server.js
```

Key details:
- `set -e` — exit immediately if any command fails
- `node ./node_modules/prisma/build/index.js` — invokes the Prisma CLI directly without relying on `npx` (which might download the wrong version)
- `exec` — replaces the shell process with `node`, so signals (SIGTERM) reach the app correctly
- `prisma migrate deploy` is idempotent — if all migrations are already applied, it's a sub-second no-op

### Dockerfile (runner stage)

The multi-stage Dockerfile must copy enough into the runner for migrations to work:

```dockerfile
# Schema + migration SQL files
COPY --from=builder /app/prisma ./prisma

# Prisma config (Prisma 7 requires this for the datasource URL)
COPY --from=builder /app/prisma.config.ts ./prisma.config.ts

# Generated Prisma Client (query engine)
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# Prisma CLI + runtime packages (schema engine, config loader, etc.)
COPY --from=builder /app/node_modules/prisma ./node_modules/prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Entrypoint script
COPY scripts/start.sh ./start.sh
RUN chmod +x ./start.sh

USER nextjs

CMD ["./start.sh"]
```

What each piece does:
- `prisma/` — contains `schema.prisma` and `migrations/` directory with SQL files
- `prisma.config.ts` — tells Prisma where to find the database (`DATABASE_URL` env var)
- `node_modules/.prisma` — generated query engine (for the app at runtime)
- `node_modules/prisma` — CLI + bundled WASM schema engine (for `migrate deploy` at startup)
- `node_modules/@prisma` — runtime packages the CLI depends on (`@prisma/engines`, `@prisma/config`, etc.)
- `start.sh` — runs migrations, then starts the app

### Prisma configuration (`prisma.config.ts`)

Prisma 7 requires a config file. The `datasource.url` field is no longer in `schema.prisma` — it lives here:

```typescript
import { defineConfig } from "prisma/config";

export default defineConfig({
  schema: "prisma/schema.prisma",
  migrations: {
    seed: "npx tsx prisma/seed.ts",
  },
  datasource: {
    url: process.env.DATABASE_URL!,
  },
});
```

Note: the `seed` property is only used when manually running `npx prisma db seed` (e.g., initial setup). It is never invoked automatically during deployment.

### Coolify settings

| Setting | Value |
|---------|-------|
| Pre-deployment command | *(empty)* |
| Post-deployment command | *(empty)* |

Migrations are handled by the container entrypoint. Coolify hooks are not needed.

---

## Prisma 7 migration notes

### Breaking changes from Prisma 5/6

These are relevant to the migration setup:

1. **`prisma.config.ts` is required.** The `datasource.url` was removed from `schema.prisma`. If `prisma.config.ts` is missing, `prisma migrate deploy` fails with: `Error: The datasource.url property is required in your Prisma config file`.

2. **`package.json` seed config removed.** The old `"prisma": {"seed": "tsx prisma/seed.ts"}` block in `package.json` no longer works. Seeding is now configured in `prisma.config.ts` under `migrations.seed`.

3. **Auto-seeding on `migrate dev` removed.** In Prisma 6 and earlier, `prisma migrate dev` automatically ran the seed script. In Prisma 7, you must run `npx prisma db seed` explicitly.

### `migration_lock.toml`

The file `prisma/migrations/migration_lock.toml` records the database provider. It should be committed to version control:

```toml
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
```

---

## Verification

### Confirm migrations run on deploy

After deploying, check the container logs. You should see:

```
[canopy-forms] Running database migrations...
Prisma schema loaded from prisma/schema.prisma.
Datasource "db": PostgreSQL database "postgres", schema "public" at "hostname:5432"
N migrations found in prisma/migrations

No pending migrations to apply.      ← (or) Applied migration: 20260219000000_add_password_changed_at

[canopy-forms] Migrations complete. Starting application...
```

### Confirm a failed migration blocks startup

To test this safely in dev: create a migration with intentionally invalid SQL (e.g., `ALTER TABLE nonexistent ADD COLUMN x TEXT;`), deploy, and confirm the container fails to start. Then delete the bad migration and redeploy.

### Confirm schema is in sync

Connect to the database and check the `_prisma_migrations` table:

```sql
SELECT migration_name, finished_at FROM _prisma_migrations ORDER BY started_at;
```

Every migration in `prisma/migrations/` should appear with a non-null `finished_at`.

---

## Troubleshooting

### `Error: The datasource.url property is required`

`prisma.config.ts` is missing from the container or `DATABASE_URL` is not set. Check:
- The Dockerfile copies `prisma.config.ts` to the runner stage
- The `DATABASE_URL` environment variable is configured in Coolify

### `npm warn exec The following package was not found and will be installed: prisma@X.Y.Z`

The Prisma CLI was not found in the container and `npx` is downloading it. This means `node_modules/prisma` was not copied to the runner. Check the `COPY --from=builder /app/node_modules/prisma ./node_modules/prisma` line in the Dockerfile.

### `P2022: The column does not exist`

The app started but migrations did not run. Check:
- Is `CMD ["./start.sh"]` in the Dockerfile (not `CMD ["node", "server.js"]`)?
- Is `start.sh` calling `prisma migrate deploy` before `node server.js`?
- Is there a migration file in `prisma/migrations/` for the missing column?

### Migrations applied but app still fails

Check if the migration SQL actually creates the column the Prisma Client expects. Run `npx prisma migrate status` in the container to compare migration state vs. schema.

---

## Manual migration workflow (enum renames, etc.)

`prisma migrate dev` is interactive — it prompts for confirmation on destructive changes. This means it **cannot run** via `docker exec` (no TTY). It also sometimes generates destructive SQL when a safe alternative exists (e.g., dropping and recreating an enum instead of renaming a value).

For these cases, create the migration manually:

### Steps

```bash
# 1. Edit prisma/schema.prisma with your change

# 2. Create the migration directory (use YYYYMMDD000000 convention)
mkdir -p prisma/migrations/20260224000000_rename_select_to_dropdown

# 3. Write the SQL by hand
cat > prisma/migrations/20260224000000_rename_select_to_dropdown/migration.sql << 'EOF'
ALTER TYPE "FieldType" RENAME VALUE 'SELECT' TO 'DROPDOWN';
EOF

# 4. Apply the SQL to the dev database via the db container
docker.exe exec canopy-forms-db psql -U user -d canopy-forms \
  -c "ALTER TYPE \"FieldType\" RENAME VALUE 'SELECT' TO 'DROPDOWN';"

# 5. Mark the migration as applied in Prisma's tracking table
docker.exe exec canopy-forms npx prisma migrate resolve \
  --applied 20260224000000_rename_select_to_dropdown

# 6. Regenerate client + restart dev server
docker.exe exec canopy-forms npx prisma generate
docker.exe restart canopy-forms

# 7. Verify no drift
docker.exe exec canopy-forms npx prisma migrate status
```

### When to use this instead of `prisma migrate dev`

| Scenario | Why manual? |
|----------|-------------|
| **Enum value rename** (`ALTER TYPE ... RENAME VALUE`) | Prisma generates drop + recreate, which fails if values are in use |
| **Non-interactive environment** | `prisma migrate dev` requires a TTY for confirmation prompts |
| **Data-preserving changes** | Any case where you need precise control over the SQL |

### Important notes

- The migration directory name **must** match exactly when calling `prisma migrate resolve --applied`
- `psql` runs on the **db container** (`canopy-forms-db`), not the app container — the app container doesn't have `psql`
- The db user is `user` (per `docker-compose.dev.yml` `POSTGRES_USER`)
- Always run `prisma migrate status` after to confirm no pending migrations and no drift
- On deploy, `prisma migrate deploy` in `start.sh` will apply this migration automatically (it reads the SQL file, not `prisma migrate dev`)

---

## Setting up a new Coolify + Prisma project

Checklist for starting a new project on the right foot:

### 1. Prisma configuration

- [ ] Create `prisma.config.ts` with `defineConfig`, `datasource.url`, and `migrations.seed`
- [ ] `schema.prisma` datasource block has `provider` but **no `url`** (url comes from config)
- [ ] `prisma/migrations/migration_lock.toml` exists and is committed
- [ ] No `"prisma": {"seed": "..."}` in `package.json` (Prisma 7 removed this)

### 2. Entrypoint script

- [ ] Create `scripts/start.sh` (see template above)
- [ ] Script uses `set -e` so failures are fatal
- [ ] Script runs `prisma migrate deploy` before starting the app
- [ ] Script uses `exec` for the final `node server.js`

### 3. Dockerfile

- [ ] Multi-stage build: `deps` → `builder` → `runner`
- [ ] Runner copies these from builder:
  - `prisma/` (schema + migrations)
  - `prisma.config.ts`
  - `node_modules/.prisma` (generated client)
  - `node_modules/prisma` (CLI for migrate deploy)
  - `node_modules/@prisma` (CLI runtime dependencies)
- [ ] Runner copies `scripts/start.sh` and `chmod +x`
- [ ] `CMD ["./start.sh"]` (not `CMD ["node", "server.js"]`)

### 4. `.dockerignore`

- [ ] `scripts/` is **not** in `.dockerignore` (it needs to be in the build context)

### 5. Coolify

- [ ] `DATABASE_URL` is set in the environment variables
- [ ] Pre-deployment command: **empty**
- [ ] Post-deployment command: **empty**
- [ ] Seeding (if needed) is a one-time manual operation: `docker exec <container> npx prisma db seed`

### 6. First deploy

- [ ] Run initial migration locally: `npx prisma migrate dev --name init`
- [ ] Commit `prisma/schema.prisma`, `prisma/migrations/`, and `prisma/migrations/migration_lock.toml`
- [ ] Deploy — container entrypoint applies the migration automatically
- [ ] Seed manually if needed: `docker exec <container> npx prisma db seed`
